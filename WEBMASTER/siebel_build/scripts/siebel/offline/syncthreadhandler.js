/*<ORACLECOPYRIGHT>
* Copyright (C) 1994-2014
* Oracle and Java are registered trademarks of Oracle and/or its affiliates.
* Other names may be trademarks of their respective owners.
* UNIX is a registered trademark of The Open Group.
*
* This software and related documentation are provided under a license agreement
* containing restrictions on use and disclosure and are protected by intellectual property laws.
* Except as expressly permitted in your license agreement or allowed by law, you may not use, copy,
* reproduce, translate, broadcast, modify, license, transmit, distribute, exhibit, perform, publish,
* or display any part, in any form, or by any means. Reverse engineering, disassembly,
* or decompilation of this software, unless required by law for interoperability, is prohibited.
*
* The information contained herein is subject to change without notice and is not warranted to be error-free.
* If you find any errors, please report them to us in writing.
*
* U.S. GOVERNMENT RIGHTS Programs, software, databases, and related documentation and technical data delivered to U.S.
* Government customers are "commercial computer software" or "commercial technical data" pursuant to the applicable
* Federal Acquisition Regulation and agency-specific supplemental regulations.
* As such, the use, duplication, disclosure, modification, and adaptation shall be subject to the restrictions and
* license terms set forth in the applicable Government contract, and, to the extent applicable by the terms of the
* Government contract, the additional rights set forth in FAR 52.227-19, Commercial Computer Software License
* (December 2007). Oracle America, Inc., 500 Oracle Parkway, Redwood City, CA 94065.
*
* This software or hardware is developed for general use in a variety of information management applications.
* It is not developed or intended for use in any inherently dangerous applications, including applications that
* may create a risk of personal injury. If you use this software or hardware in dangerous applications,
* then you shall be responsible to take all appropriate fail-safe, backup, redundancy,
* and other measures to ensure its safe use. Oracle Corporation and its affiliates disclaim any liability for any
* damages caused by use of this software or hardware in dangerous applications.
*
* This software or hardware and documentation may provide access to or information on content,
* products, and services from third parties. Oracle Corporation and its affiliates are not responsible for and
* expressly disclaim all warranties of any kind with respect to third-party content, products, and services.
* Oracle Corporation and its affiliates will not be responsible for any loss, costs,
* or damages incurred due to your access to or use of third-party content, products, or services.
</ORACLECOPYRIGHT>*/
/* 8.1.1.14SIA[23044]PATCHSET7 */
if(typeof(SiebelApp.SyncThreadHandler)==="undefined"){SiebelJS.Namespace("SiebelApp.SyncThreadHandler");SiebelApp.SyncThreadHandler=(function(){var u=SiebelApp.Constants;var v=SiebelApp.Offlineconstants;var p=SiebelApp.OfflineAppSettings;var d=SiebelApp.OfflineUtils;var n=p.GetPkgStatus();var t=false;var s,a,e;var x=window.localStorage;var m=SiebelApp.OfflineCacheConfig.get("PRO_SYNCQUEUE_DB_TBL_COLS");var j=SiebelApp.OfflineCacheConfig.get("PRO_SYNCQUEUE_DB_TBL");function k(){var B;C=function C(){return B};C.prototype=this;B=new C();B.constructor=C;return B}var z=new k();k.prototype.SyncInProgress=function(){return t};k.prototype.SyncInUISession=function(){t=true;var D=p.GetMode();SiebelApp.OfflineUtils.CcfLogEvent([v.get("LOG_EVT_COMMON"),103,11,56,SiebelApp.BrowserCacheMgr.GetSyncNodeId()]);if(!s){s=SiebelAppFacade.HTMLTemplateManager.GenerateMarkup({type:u.get("SWE_CTRL_IMAGECONTROL"),src:"images/white.gif",className:"appCacheProgress1"})}if(!a){a=SiebelAppFacade.HTMLTemplateManager.GenerateMarkup({type:u.get("SWE_CTRL_IMAGECONTROL"),src:"images/white.gif",className:"goOffline"})}n=p.GetPkgStatus();var B=SiebelApp.OfflineAppMgr.Ping(true);e=SiebelApp.S_App.GetSRN();if(!B){if(D){p.SetUpSyncStatus(true);p.SetUpSyncPostRefresh(true)}if(n){p.ReloadApp()}else{var C=SiebelApp.S_App.OfflineLocaleObject.GetLocalString("IDS_DOUI_ERR_OFFLINE_PKG");SiebelApp.OfflineUtils.CcfLogEvent([v.get("LOG_EVT_COMMON"),27,13,84,C]);alert(C)}return}else{e=p.GetSRN()}$("#_sweappmenu").prepend("<div id='progressbar' class='progressbar'>"+a+"</div>");SiebelApp.S_App.uiStatus.Busy({mask:true,timeOut:false});SiebelApp.AttachmentMgr.InitAttachmentList();if(D){o.call(this)}else{q.call(this)}};function q(){if(n){SiebelApp.S_App.UpdateSyncStatus("IncDataDownLoad");var C=CCFMiscUtil_CreatePropSet();C.SetPropertyStr(u.get("SWE_CMD_ARG"),"GetLastTxn");d.CcfLogEvent([v.get("LOG_EVT_UPSYNC"),49,11,56]);var B=function(D){var E=CCFMiscUtil_CreatePropSet();E.DecodeFromString(D);$(".progressbar").find("img").removeClass().addClass("appCacheProgress3");if(SiebelApp.OfflineAppMgr.CheckValidation(E)){if(E.propArray.Status!=="OK"){SiebelApp.OfflineUtils.CcfLogEvent([v.get("LOG_EVT_UPSYNC"),63,11,65,E.propArray.Status]);SiebelJS.Log(E.propArray.Status)}else{r.call(this,E);$.callback(this,function(){f.call(this,E);$.callback(this,function(){i.call(this);E=null})})}}else{t=false;SiebelApp.S_App.uiStatus.Free()}};b.call(this,C,B)}else{y.call(this)}}function y(D){var E=CCFMiscUtil_CreatePropSet();var C=SiebelApp.S_App.IsAutoOn();D=D?1:0;E.SetPropertyStr(u.get("SWE_CMD_ARG"),"GoOffline");E.SetPropertyStr(v.get("REGENERATEMETADATA"),D);E.SetPropertyStr(u.get("SWE_IS_AUTO_ON"),C);SiebelApp.S_App.UpdateSyncStatus("FullDownLoad");d.CcfLogEvent([v.get("LOG_EVT_COMMON"),79,11,56,d.GetTS()]);var F=d.TimerFactory(function(){d.CcfLogEvent([v.get("LOG_EVT_COMMON"),41,11,56,""])},{onTimeout:function(){d.CcfLogEvent([v.get("LOG_EVT_COMMON"),41,11,56,"Timed out"])}});var B=function(I){E=null;var G=true;if(F){F.stop()}var H={};H=SiebelApp.AjaxRequestMgr.ProcessToolbarResponse(I,true);G=H.bContinue;if(G){g.call(this);H.callback.apply(this,H.args)}else{SiebelApp.S_App.uiStatus.Free();t=false}};b.call(this,E,B)}function g(){var D=CCFMiscUtil_CreatePropSet();D.SetPropertyStr(u.get("SWE_CMD_ARG"),"GetOfflineData");D.SetPropertyStr(v.get("LAST_SYNC_TS"),x.getItem("TS")?x.getItem("TS"):"");var B=d.TimerFactory(function(){d.CcfLogEvent([v.get("LOG_EVT_COMMON"),89,11,56,""])},{onTimeout:function(){d.CcfLogEvent([v.get("LOG_EVT_COMMON"),89,11,56,"Timed out"])}});var C=function(F){D=null;if(B){B.stop()}var E=SiebelApp.AjaxRequestMgr.ProcessToolbarResponse(F,false);if(E.bContinue){var G=CCFMiscUtil_CreatePropSet();G.SetPropertyStr(u.get("SWE_CMD_ARG"),"GetOfflineData");G.SetPropertyStr("ACK",1);G.SetPropertyStr(v.get("LAST_SYNC_TS"),x.getItem("TS")?x.getItem("TS"):"");G.SetPropertyStr("iSync",0);b.call(this,G)}else{t=false;SiebelApp.S_App.uiStatus.Free()}};SiebelApp.S_App.UpdateSyncStatus("FullDownLoad");d.CcfLogEvent([v.get("LOG_EVT_COMMON"),81,11,56,d.GetTS()]);b.call(this,D,C)}function i(){var D=CCFMiscUtil_CreatePropSet();D.SetPropertyStr(u.get("SWE_CMD_ARG"),"GetOfflineData");D.SetPropertyStr(v.get("LAST_SYNC_TS"),x.getItem("TS"));D.SetPropertyStr("iSync",1);D.SetPropertyStr("SRFId",x.getItem("SRFId"));var B=d.TimerFactory(function(){d.CcfLogEvent([v.get("LOG_EVT_COMMON"),89,11,56,""])},{onTimeout:function(){d.CcfLogEvent([v.get("LOG_EVT_COMMON"),89,11,56,"Timed out"])}});var C=function(G){D=null;if(B){B.stop()}var J;var F=["IDS_DOUI_ERR_DATA_OUTDTD","IDS_DOUI_ERR_NODECHANGED_BKUP_DATA","IDS_DOUI_ERR_BO_FILTER_CHNG","IDS_DOUI_ERR_BC_FILTER_CHNG","IDS_DOUI_ERR_SRF_EXPIRED","IDS_DOUI_ERR_RESP_CHNG","IDS_DOUI_ERR_UPOSCHANGED_BKUP_DATA"];var M=["Data_OutDated","Node_ReExtracted","Default_BO_Filter_Changed","BC_Filter_Changed","SRF_Changed","Responsibilty_Changed","Position_Changed"];var L=CCFMiscUtil_CreatePropSet();L.DecodeFromString(G);var N=L.GetType();if(N){N=N.toString()}var E=M.indexOf(N);if(E!==-1){var H=F[E];var K=SiebelApp.S_App.OfflineLocaleObject.GetLocalString(H);d.CcfLogEvent([v.get("LOG_EVT_COMMON"),27,11,56,K]);alert(K);p.SetData(false);p.SetMetadata(false);$("#_sweappmenu").prepend("<div id='progressbar' class ='progressbar'>"+a+"</div>");if(E>3){p.SetSchemaStatus(1);if(E>4){J=true}}y(J)}else{if(N==="NoNewData"){p.OnSuccessfulDataDownload();if(x.getItem("appCacheDone")&&JSON.parse(x.getItem("appCacheDone"))){SiebelApp.Metadata.Load(true);$.callback(this,function(){SiebelApp.AttachmentMgr.SetPostDownloadAction(function(){p.ReloadToOffline(true)});SiebelApp.AttachmentMgr.DownloadAllAttachments()})}}else{$("#_sweappmenu").prepend("<div id='progressbar' class ='progressbar'>"+a+"</div>");SiebelApp.AjaxRequestMgr.ProcessToolbarResponse(G,false);var I=CCFMiscUtil_CreatePropSet();I.SetPropertyStr(u.get("SWE_CMD_ARG"),"GetOfflineData");I.SetPropertyStr("ACK",1);I.SetPropertyStr(v.get("LAST_SYNC_TS"),x.getItem("TS")?x.getItem("TS"):"");I.SetPropertyStr("iSync",0);b.call(this,I)}}};SiebelApp.S_App.UpdateSyncStatus("IncDataDownLoad");d.CcfLogEvent([v.get("LOG_EVT_COMMON"),80,11,56,d.GetTS()]);b.call(this,D,C)}function o(){SiebelApp.S_App.UpdateSyncStatus("UpSync");$("#_sweappmenu").prepend("<div id='progressbar' class ='progressbar'>"+s+"</div>");var C=CCFMiscUtil_CreatePropSet();C.SetPropertyStr(u.get("SWE_CMD_ARG"),"GetLastTxn");d.CcfLogEvent([v.get("LOG_EVT_UPSYNC"),49,11,56]);var B=function(D){$(".progressbar").find("img").removeClass().addClass("appCacheProgress2");C=null;var E=CCFMiscUtil_CreatePropSet();E.DecodeFromString(D);SiebelApp.OfflineUtils.CcfLogEvent([v.get("LOG_EVT_UPSYNC"),62,11,65,"started"]);if(SiebelApp.OfflineAppMgr.CheckValidation(E)){if(E.propArray.Status!=="OK"){SiebelApp.OfflineUtils.CcfLogEvent([v.get("LOG_EVT_UPSYNC"),63,11,65,E.propArray.Status]);SiebelJS.Log(E.propArray.Status)}else{r.call(this,E);$.callback(this,function(){f.call(this,E);$.callback(this,function(){c.call(this);E=null})})}}else{t=false;SiebelApp.S_App.uiStatus.Free()
}};b.call(this,C,B)}function r(D){var C=D.GetPropertyAsStr("LastProcTranId");var B=D.GetPropertyAsStr("LastTsTracker");B=SiebelApp.S_App.LocaleObject.GetStringFromDateTime(B,"MM/DD/YYYY HH:mm:ss","YYYY/MM/DD HH:mm:ss");SiebelApp.OfflineUtils.CcfLogEvent([v.get("LOG_EVT_UPSYNC"),64,11,65,C]);SiebelJS.Log("Last Transaction Id...."+C);SiebelJS.Log("Synchronizing offline data....");if(C!==""){l.call(this,C,B)}$(".progressbar").find("img").removeClass().addClass("appCacheProgress3")}function f(H){var E=H.GetPropertyAsStr("TxnId");SiebelApp.OfflineUtils.CcfLogEvent([v.get("LOG_EVT_UPSYNC"),109,11,65,E]);if(E){var K=SiebelApp.OfflineCacheConfig;var J=K.get("PRO_SYNCQUEUE_DB_TBL");var B=K.get("PRO_SYNCQUEUE_DB_TBL_COLS");var G=SiebelApp.SqlBuilder.UpdateRecord(J,[B.SyncStatus],[v.get("SYNC_UPSYNCED")]);var I={};I.FieldName=B.TransactionId;I.Val=E;var D=SiebelApp.SqlBuilder.SelectRecord(J,[I],["RecordNum"]);var C="( "+D.selectQuery+" )";var F=SiebelApp.SqlBuilder.BuildWhereClause("<=","RecordNum",C);G=G+" WHERE "+F;SiebelApp.BrowserCacheMgr.Execute(G,D.valList)}}function c(){var D="'"+v.get("SYNC_NEW")+"'";var B=SiebelApp.SqlBuilder.BuildWhereClause("=",m.SyncStatus,D);B=SiebelApp.SqlBuilder.BuildWhereClause("!=",m.Request,"''",B);var C=SiebelApp.SqlBuilder.SelectRecord(j,B);SiebelApp.BrowserCacheMgr.Execute(C.selectQuery,C.valList,true);$.callback(this,function(G){if(!G.err){var E=G.retVal;var H=E.length;if(H>0){var F=CCFMiscUtil_CreatePropSet();F.SetPropertyStr(u.get("SWE_CMD_ARG"),"SynchronizeOfflineData");F=h.call(this,E,F);b.call(this,F,A)}else{A.call(this,null,true)}}})}function A(E,H){if(E){var B=CCFMiscUtil_CreatePropSet();B.DecodeFromString(E);if(B.propArray.Generic_SyncErr==="OK"){p.SetSyncStatus(false)}var G="'"+v.get("SYNC_NEW")+"'";var D=SiebelApp.SqlBuilder.BuildWhereClause("=",m.SyncStatus,G);var F=w.call(this);var C=SiebelApp.SqlBuilder.UpdateRecord(j,[m.UpSyncTime],[F]);C=C+" WHERE "+D;SiebelApp.BrowserCacheMgr.Execute(C)}else{if(!H){SiebelApp.S_App.UpdateSyncStatus("UpSyncFailed");d.CcfLogEvent([v.get("LOG_EVT_UPSYNC"),43,11,56]);$(".progressbar").remove();t=false;SiebelApp.S_App.uiStatus.Free()}else{p.SetSyncStatus(false)}}$.callback(this,function(){SiebelApp.S_App.UpdateSyncStatus("UpSyncDone");SiebelJS.Log("Synchronizing offline data... is Done");d.CcfLogEvent([v.get("LOG_EVT_UPSYNC"),42,11,56]);if(p.GetSyncType()===v.get("SYNC_TYPE_GOONLINE")){p.SetMode(false);t=false;SiebelApp.S_App.uiStatus.Free();$(".progressbar").find("img").removeClass().addClass("appCacheProgress6");p.ReloadApp()}else{if(p.GetSyncType()===v.get("SYNC_TYPE_UPSYNC_ISYNC")){$(".progressbar").find("img").removeClass().addClass("appCacheProgress4");i.call(this)}else{$(".progressbar").remove();t=false;SiebelApp.S_App.uiStatus.Free()}}})}function w(){var C=new Date();var H=C.getUTCMonth();var B=C.getUTCDate();var D=C.getUTCHours();var G=C.getUTCMinutes();var E=C.getUTCSeconds();H=H+1;if(H<10){H="0"+H}if(B<10){B="0"+B}if(D<10){D="0"+D}if(G<10){G="0"+G}if(E<10){E="0"+E}var F=C.getUTCFullYear()+"/"+H+"/"+B+" "+D+":"+G+":"+E;return F}function l(G,C){var E=SiebelApp.SqlBuilder.DeleteRecords(j);var B=SiebelApp.SqlBuilder.BuildWhereClause("=",m.TransactionId,"'"+G+"'");var F=SiebelApp.SqlBuilder.SelectRecord(j,B,["RecordNum"]);var D=F.selectQuery;B=SiebelApp.SqlBuilder.BuildWhereClause("<=","RecordNum","("+D+")");if(C){B=SiebelApp.SqlBuilder.BuildWhereClause("<",m.UpSyncTime,"'"+C+"'",B,"AND")}E=E+" WHERE "+B;d.CcfLogEvent([v.get("LOG_EVT_UPSYNC"),95,11,55,E]);SiebelApp.BrowserCacheMgr.Execute(E,F.valList);d.CcfLogEvent([v.get("LOG_EVT_UPSYNC"),66,11,55,G])}function h(F,E){var C;var G="~";var J="";var K=1;var I,B;for(var D=0;D<F.length;D++){C="";C=F[D].Request;d.CcfLogEvent([v.get("LOG_EVT_UPSYNC"),96,11,99,F[D].TransactionId]);C=encodeURIComponent(C);J=J.concat(C,G);if(D===(F.length-1)){I=F[D].RecordNum;B=F[D].TransactionId}}if(J){J=J.slice(0,((J.length)-1));var H=J.split("~");E.SetPropertyStr(v.get("SYNC_PKG_LENGTH"),H.length);E.SetPropertyStr(v.get("TOTAL_SYNC_PACKAGE_LENGTH"),H.length);E.SetPropertyStr(v.get("END_OF_FILE"),K);E.SetPropertyStr(v.get("SYNC_REQUEST_LAST_TRANSID"),B);E.SetPropertyStr(v.get("SYNC_REQUEST_LAST_RECORDNUM"),I);E.SetPropertyStr(v.get("SYNC_PKG_REQUESTS"),J)}return E}function b(C,E){var D=SiebelApp.BrowserCacheMgr.GetSyncNodeId();C.SetPropertyStr(u.get("SWE_ARG_KEEP_CONTEXT"),1);C.SetPropertyStr(u.get("SWE_VIEW_RPC_ARG"),1);C.SetPropertyStr(u.get("SYNC_NODE_ID"),D);C.SetPropertyStr(u.get("SWE_PROP_SESSION_RANDOM_NUMBER"),e);var B={};B.async=true;B.data=SiebelApp.Utils.EncodeToQueryString(C,false);B.context=this;B.type="POST";B.async=true;B.contentType="application/x-www-form-urlencoded";B.url=SiebelApp.S_App.GetPageURL();B.successfncallback=E;SiebelApp.AjaxRequestMgr.Ajax(B,false,true)}return z}())};