/*<ORACLECOPYRIGHT>
* Copyright (C) 1994-2014
* Oracle and Java are registered trademarks of Oracle and/or its affiliates.
* Other names may be trademarks of their respective owners.
* UNIX is a registered trademark of The Open Group.
*
* This software and related documentation are provided under a license agreement
* containing restrictions on use and disclosure and are protected by intellectual property laws.
* Except as expressly permitted in your license agreement or allowed by law, you may not use, copy,
* reproduce, translate, broadcast, modify, license, transmit, distribute, exhibit, perform, publish,
* or display any part, in any form, or by any means. Reverse engineering, disassembly,
* or decompilation of this software, unless required by law for interoperability, is prohibited.
*
* The information contained herein is subject to change without notice and is not warranted to be error-free.
* If you find any errors, please report them to us in writing.
*
* U.S. GOVERNMENT RIGHTS Programs, software, databases, and related documentation and technical data delivered to U.S.
* Government customers are "commercial computer software" or "commercial technical data" pursuant to the applicable
* Federal Acquisition Regulation and agency-specific supplemental regulations.
* As such, the use, duplication, disclosure, modification, and adaptation shall be subject to the restrictions and
* license terms set forth in the applicable Government contract, and, to the extent applicable by the terms of the
* Government contract, the additional rights set forth in FAR 52.227-19, Commercial Computer Software License
* (December 2007). Oracle America, Inc., 500 Oracle Parkway, Redwood City, CA 94065.
*
* This software or hardware is developed for general use in a variety of information management applications.
* It is not developed or intended for use in any inherently dangerous applications, including applications that
* may create a risk of personal injury. If you use this software or hardware in dangerous applications,
* then you shall be responsible to take all appropriate fail-safe, backup, redundancy,
* and other measures to ensure its safe use. Oracle Corporation and its affiliates disclaim any liability for any
* damages caused by use of this software or hardware in dangerous applications.
*
* This software or hardware and documentation may provide access to or information on content,
* products, and services from third parties. Oracle Corporation and its affiliates are not responsible for and
* expressly disclaim all warranties of any kind with respect to third-party content, products, and services.
* Oracle Corporation and its affiliates will not be responsible for any loss, costs,
* or damages incurred due to your access to or use of third-party content, products, or services.
</ORACLECOPYRIGHT>*/
/* 8.1.1.14SIA[23044]PATCHSET7 */
if(typeof(SiebelApp.WebDB)==="undefined"){SiebelJS.Namespace("SiebelApp.WebDB");SiebelApp.WebDB=(function(){var a=SiebelApp.Offlineconstants;var b=SiebelApp.OfflineUtils;var c=null;function e(){var f;var i=0;var g=undefined;h=function h(){c=JSON.parse(window.localStorage.getItem(a.get("TABLEINFO")));return f};h.prototype=this;f=new h();f.constructor=h;this.IncrementTxnCnt=function(){i++};this.DecrementTxnCnt=function(){i--;if(g&&this.GetTxnCnt()<=0){g();this.ResetPostTxnCallback()}};this.SetPostTxnCallback=function(j){if(this.GetTxnCnt()<=0){j();return}g=j};this.ResetPostTxnCallback=function(){g=undefined};this.GetTxnCnt=function(){return i};return f}var d;d=new e();e.prototype.Initialize=function(i){var f=$.Deferred();var k=i.dbName;var l=i.version;var o=i.displayName;var p=i.maxSize;var q=i.tables;var j=i.columns;var m;var g=SiebelApp.WebDB.initDatabase(k,l,o,p);if(g&&q){for(var h=0;h<q.length;h++){m=SiebelApp.SqlBuilder.CreateTable(q[h],j[q[h]]);SiebelApp.WebDB.CreateTable(m)}}f.resolve(g);return f.promise()};e.prototype.initDatabase=function(f,h,g,l){var i=true;try{if(!window.openDatabase){alert("Databases are not supported in this browser.");i=false}else{WebDB=openDatabase(f,h,g,l)}}catch(k){if(k===2){SiebelJS.Log("Invalid database version.")}else{if(k.code===18){SiebelJS.Log("In sufficient memory. Error: "+k+".");var j=SiebelApp.S_App.OfflineLocaleObject.GetLocalString("IDS_DOUI_ERR_INSUFFICIENT_MEMORY");alert(j)}else{SiebelJS.Log("Unknown error "+k+".")}}i=false}return i};e.prototype.DeleteTable=function(f){SiebelApp.WebDB.IncrementTxnCnt();WebDB.transaction(function(g){g.executeSql(f,[],function(h,i){SiebelApp.WebDB.DecrementTxnCnt();h=null;i=null},function(h,i){SiebelApp.WebDB.DecrementTxnCnt();SiebelJS.Log("Oops.  Error was "+i.message+" (Code "+i.code+")");SiebelJS.Log("Oops.  Error was "+i.message+" (Code "+i.code+")");SiebelJS.Log("WebStore.DeleteTable -> DeleteQuery: "+f);h=null;i=null;b.CcfLogEvent([a.get("LOG_EVT_COMMON"),70,12,57,f]);b.CcfLogEvent([a.get("LOG_EVT_COMMON"),71,12,57,i.message,i.code]);return true})})};e.prototype.CreateTable=function(f){SiebelApp.WebDB.IncrementTxnCnt();WebDB.transaction(function(g){g.executeSql(f,[],function(h,i){SiebelApp.WebDB.DecrementTxnCnt();h=null;i=null},function(h,i){SiebelApp.WebDB.DecrementTxnCnt();if(i.code===1){SiebelJS.Log("DB Table already exists")}else{SiebelJS.Log("Oops.  Error was "+i.message+" (Code "+i.code+")");SiebelJS.Log("Oops.  Error was "+i.message+" (Code "+i.code+")");SiebelJS.Log("WebStore.CreateTable -> CreateQuery: "+f);h=null;i=null}b.CcfLogEvent([a.get("LOG_EVT_COMMON"),70,12,58,f]);b.CcfLogEvent([a.get("LOG_EVT_COMMON"),71,12,58,i.message,i.code]);return true})})};e.prototype.InsertRecordSet=function(t,g,p,r){var u=500;var s=[];var f=g.length;var l="INSERT INTO "+t+" (";for(var o=0;o<f;o++){l+=' "'+g[o]+'"';if(o<f-1){l+=", "}}l+=")";var n=p.length;for(var h=0;h<n&&h<u;h++){l+=" SELECT ";for(var m=0;m<f;m++){var q=(p[h])[m];q=q.replace(/\"/g,'""');l+=' "'+q+'"';if(m<f-1){l+=", "}}l+=" UNION ALL "}l=SiebelApp.OfflineUtils.RTrim(l," UNION ALL ");SiebelApp.WebDB.IncrementTxnCnt();WebDB.transaction(function(i){i.executeSql(l,[],function(j,k){if(n>u){s=p.slice(u);SiebelApp.WebDB.InsertRecordSet(t,g,s,r)}else{if(r){r()}}SiebelApp.WebDB.DecrementTxnCnt();j=null;k=null},function(j,k){SiebelJS.Log("Oops.  Error was "+k.message+" (Code "+k.code+")");SiebelJS.Log("Oops.  Error was "+k.message+" (Code "+k.code+")");SiebelJS.Log("WebStore.InsertRecordSet -> InsertQuery: "+l);if(n>u){s=p.slice(u);SiebelApp.WebDB.InsertRecordSet(t,g,s,r)}else{b.CcfLogEvent([a.get("LOG_EVT_COMMON"),70,12,59,l]);b.CcfLogEvent([a.get("LOG_EVT_COMMON"),71,12,59,k.message,k.code])}SiebelApp.WebDB.DecrementTxnCnt();j=null;k=null;return true})})};e.prototype.SelectAll=function(j,h,f){var i;var g=[];SiebelApp.WebDB.IncrementTxnCnt();WebDB.transaction(function(k){k.executeSql(j.selectQuery,[],function(l,m){for(var n=0;n<m.rows.length;n++){i=m.rows.item(n);g.push(i)}f(g);SiebelApp.WebDB.DecrementTxnCnt();l=null;m=null},function(l,m){SiebelApp.WebDB.DecrementTxnCnt();if(m.code===1){SiebelJS.Log("DB Table already exists")}else{SiebelJS.Log("Oops.  Error was "+m.message+" (Code "+m.code+")");SiebelJS.Log("Oops.  Error was "+m.message+" (Code "+m.code+")");SiebelJS.Log("WebStore.SelectAll -> SelectQuery: "+j);l=null;m=null;b.CcfLogEvent([a.get("LOG_EVT_COMMON"),70,12,60,j]);b.CcfLogEvent([a.get("LOG_EVT_COMMON"),71,12,60,m.message,m.code])}return true})})};e.prototype.SelectAllUpSync=function(i,f){var h;var g=[];SiebelApp.WebDB.IncrementTxnCnt();WebDB.transaction(function(j){j.executeSql(i,[],function(k,l){for(var m=0;m<l.rows.length;m++){h=l.rows.item(m);g.push(h)}f(g);SiebelApp.WebDB.DecrementTxnCnt();k=null;l=null},function(k,l){SiebelApp.WebDB.DecrementTxnCnt();if(l.code===1){SiebelJS.Log("DB Table already exists")}else{SiebelJS.Log("Oops.  Error was "+l.message+" (Code "+l.code+")");SiebelJS.Log("Oops.  Error was "+l.message+" (Code "+l.code+")");SiebelJS.Log("WebStore.SelectAll -> SelectQuery: "+i);b.CcfLogEvent([a.get("LOG_EVT_COMMON"),70,12,66,i]);b.CcfLogEvent([a.get("LOG_EVT_COMMON"),71,12,66,l.message,l.code])}k=null;l=null;return true})})};e.prototype.SelectAll=function(j,g){var i=new $.Deferred();var h;var f=[];SiebelApp.WebDB.IncrementTxnCnt();WebDB.transaction(function(k){k.executeSql(j.selectQuery,[],function(l,m){for(var n=0;n<m.rows.length;n++){h=m.rows.item(n);f.push(h)}i.resolve(f);SiebelApp.WebDB.DecrementTxnCnt();l=null;m=null},function(l,m){SiebelApp.WebDB.DecrementTxnCnt();if(m.code===1){SiebelJS.Log("DB Table already exists")}else{i.reject(null);SiebelJS.Log("Oops.  Error was "+m.message+" (Code "+m.code+")");SiebelJS.Log("Oops.  Error was "+m.message+" (Code "+m.code+")");SiebelJS.Log("WebStore.SelectAll -> SelectQuery: "+j);b.CcfLogEvent([a.get("LOG_EVT_COMMON"),70,12,60,j]);b.CcfLogEvent([a.get("LOG_EVT_COMMON"),71,12,60,m.message,m.code])}l=null;m=null;return true})});return i.promise()};e.prototype.Execute=function(g,f,i){var h=new $.Deferred();SiebelApp.WebDB.IncrementTxnCnt();WebDB.transaction(function(j){j.executeSql(g,f,function(k,l){SiebelApp.WebDB.DecrementTxnCnt();var o;if(l.rows){var n=l.rows.length;if(i===true){o=[];for(var m=0;m<n;m++){o.push(l.rows.item(m))}}else{if(n>0){o=l.rows.item(0)}}}h.resolve(o);k=null;l=null},function(k,l){SiebelApp.WebDB.DecrementTxnCnt();SiebelJS.Log("Oops.  Error was "+l.message+" (Code "+l.code+")");SiebelJS.Log("WebStore.Execute ->: "+g);if(f&&f.toString){b.CcfLogEvent([a.get("LOG_EVT_COMMON"),72,12,12,g,f.toString()])}else{b.CcfLogEvent([a.get("LOG_EVT_COMMON"),70,12,12,g])}b.CcfLogEvent([a.get("LOG_EVT_COMMON"),71,12,12,l.message,l.code]);h.reject(l);k=null;l=null;return true})});return h.promise()};e.prototype.DoesTableExist=function(f){if(!c){c=window.localStorage.getItem(a.get("TABLEINFO"))}if(c){return(c.hasOwnProperty(f))}else{return false}};e.prototype.UpdateRecord=function(g,h){var f=new $.Deferred();SiebelApp.WebDB.IncrementTxnCnt();WebDB.transaction(function(i){SiebelApp.WebDB.DecrementTxnCnt();
i.executeSql(g,[h],function(j,k){f.resolve(k.rowsAffected);j=null;k=null},function(j,k){SiebelApp.WebDB.DecrementTxnCnt();if(k.code===1){SiebelJS.Log("Unable to Update the record.")}else{SiebelJS.Log("Oops.  Error was "+k.message+" (Code "+k.code+")");SiebelJS.Log("Oops.  Error was "+k.message+" (Code "+k.code+")");SiebelJS.Log("WebStore.UpdateRecord -> UpdateQuery: "+g);if(h){b.CcfLogEvent([a.get("LOG_EVT_COMMON"),72,12,67,g,h])}else{b.CcfLogEvent([a.get("LOG_EVT_COMMON"),70,12,67,g])}b.CcfLogEvent([a.get("LOG_EVT_COMMON"),71,12,67,k.message,k.code])}f.reject(k);j=null;k=null;return true})});return f.promise()};e.prototype.DoesFieldExist=function(f,i){var g=false;i=i.toUpperCase();if(!c){c=JSON.parse(window.localStorage.getItem(a.get("TABLEINFO")))}if(c){var h=c[f];if(h){g=(h.indexOf(i)!==-1)}}return g};return d}())};